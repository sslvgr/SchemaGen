name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: false
        type: boolean
        default: false

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  publish:
    name: Build and Publish Packages
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for MinVer versioning
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: |
        echo "Restoring NuGet packages..."
        if ! dotnet restore; then
          echo "❌ Package restore failed"
          exit 1
        fi
        echo "✅ Package restore completed successfully"
      
    - name: Build solution
      run: |
        echo "Building solution in Release configuration..."
        if ! dotnet build --no-restore --configuration Release; then
          echo "❌ Build failed"
          exit 1
        fi
        echo "✅ Build completed successfully"
      
    - name: Run tests
      run: |
        echo "Running tests..."
        if ! dotnet test --no-build --configuration Release --verbosity normal; then
          echo "❌ Tests failed"
          exit 1
        fi
        echo "✅ All tests passed"
      
    - name: Create packages
      run: |
        echo "Creating NuGet packages..."
        if ! dotnet pack --no-build --configuration Release --output ./artifacts/packages; then
          echo "❌ Package creation failed"
          exit 1
        fi
        echo "✅ Packages created successfully"
        
    - name: Verify packages created
      run: |
        echo "Verifying packages were created..."
        package_count=$(find ./artifacts/packages -name "*.nupkg" | wc -l)
        symbol_count=$(find ./artifacts/packages -name "*.snupkg" | wc -l)
        
        echo "Found $package_count .nupkg files and $symbol_count .snupkg files"
        
        if [ $package_count -eq 0 ]; then
          echo "❌ No .nupkg files found in ./artifacts/packages"
          exit 1
        fi
        
        if [ $symbol_count -eq 0 ]; then
          echo "⚠️ No .snupkg files found - symbol packages may not be configured"
        fi
        
        echo "✅ Package verification completed"
      
    - name: Install package validation tool
      run: |
        echo "Installing Microsoft.DotNet.PackageValidation.Tool..."
        if ! dotnet tool install --global Microsoft.DotNet.PackageValidation.Tool; then
          echo "❌ Failed to install package validation tool"
          exit 1
        fi
        echo "✅ Package validation tool installed successfully"
      
    - name: Validate packages
      run: |
        validation_failed=false
        for package in ./artifacts/packages/*.nupkg; do
          echo "Validating package: $package"
          if ! dotnet package validate "$package"; then
            echo "❌ Package validation failed for: $package"
            validation_failed=true
          else
            echo "✅ Package validation passed for: $package"
          fi
        done
        
        if [ "$validation_failed" = true ]; then
          echo "❌ One or more packages failed validation. Stopping publish process."
          exit 1
        fi
        
        echo "✅ All packages passed validation."
        
    - name: Verify GitHub authentication
      run: |
        echo "Verifying GitHub Packages authentication..."
        if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "❌ GITHUB_TOKEN is not set"
          exit 1
        fi
        echo "✅ GitHub authentication verified"
        
    - name: List packages
      run: |
        echo "Generated packages:"
        ls -la ./artifacts/packages/
        
    - name: Publish to GitHub Packages
      run: |
        publish_failed=false
        retry_count=3
        retry_delay=30
        
        for package in ./artifacts/packages/*.nupkg; do
          echo "Publishing package: $package"
          
          for attempt in $(seq 1 $retry_count); do
            echo "Attempt $attempt of $retry_count for $package"
            
            if dotnet nuget push "$package" \
              --source "https://nuget.pkg.github.com/Teez-Technologies/index.json" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --skip-duplicate \
              --timeout 300; then
              echo "✅ Successfully published: $package"
              break
            else
              echo "❌ Failed to publish $package (attempt $attempt)"
              if [ $attempt -lt $retry_count ]; then
                echo "Retrying in $retry_delay seconds..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))  # Exponential backoff
              else
                echo "❌ All retry attempts failed for: $package"
                publish_failed=true
              fi
            fi
          done
        done
        
        if [ "$publish_failed" = true ]; then
          echo "❌ One or more packages failed to publish to GitHub Packages"
          exit 1
        fi
        
        echo "✅ All packages successfully published to GitHub Packages"
        
    - name: Publish symbol packages to GitHub Packages
      run: |
        symbol_publish_failed=false
        retry_count=3
        retry_delay=30
        
        for package in ./artifacts/packages/*.snupkg; do
          echo "Publishing symbol package: $package"
          
          for attempt in $(seq 1 $retry_count); do
            echo "Attempt $attempt of $retry_count for $package"
            
            if dotnet nuget push "$package" \
              --source "https://nuget.pkg.github.com/Teez-Technologies/index.json" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --skip-duplicate \
              --timeout 300; then
              echo "✅ Successfully published symbol package: $package"
              break
            else
              echo "❌ Failed to publish symbol package $package (attempt $attempt)"
              if [ $attempt -lt $retry_count ]; then
                echo "Retrying in $retry_delay seconds..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))  # Exponential backoff
              else
                echo "❌ All retry attempts failed for symbol package: $package"
                symbol_publish_failed=true
              fi
            fi
          done
        done
        
        if [ "$symbol_publish_failed" = true ]; then
          echo "❌ One or more symbol packages failed to publish to GitHub Packages"
          exit 1
        fi
        
        echo "✅ All symbol packages successfully published to GitHub Packages"
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v6
      with:
        name: packages-${{ github.event.release.tag_name || inputs.version }}
        path: ./artifacts/packages/
        retention-days: 90
        
    - name: Attach packages to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ./artifacts/packages/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  publish-nuget-org:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: publish
    if: github.event.release.prerelease == false || inputs.prerelease == false
    environment: nuget-org
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: packages-${{ github.event.release.tag_name || inputs.version }}
        path: ./artifacts/packages/
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Verify NuGet.org authentication
      run: |
        echo "Verifying NuGet.org authentication..."
        if [ -z "${{ secrets.NUGET_API_KEY }}" ]; then
          echo "❌ NUGET_API_KEY is not set"
          exit 1
        fi
        echo "✅ NuGet.org authentication verified"
        
    - name: Verify downloaded packages
      run: |
        echo "Verifying downloaded packages..."
        package_count=$(find ./artifacts/packages -name "*.nupkg" | wc -l)
        symbol_count=$(find ./artifacts/packages -name "*.snupkg" | wc -l)
        
        echo "Found $package_count .nupkg files and $symbol_count .snupkg files"
        
        if [ $package_count -eq 0 ]; then
          echo "❌ No .nupkg files found in downloaded artifacts"
          exit 1
        fi
        
        echo "✅ Package verification completed"
        
    - name: Publish to NuGet.org
      run: |
        publish_failed=false
        retry_count=3
        retry_delay=30
        
        for package in ./artifacts/packages/*.nupkg; do
          # Skip symbol packages for NuGet.org (they're handled separately)
          if [[ "$package" != *.snupkg ]]; then
            echo "Publishing package to NuGet.org: $package"
            
            for attempt in $(seq 1 $retry_count); do
              echo "Attempt $attempt of $retry_count for $package"
              
              if dotnet nuget push "$package" \
                --source "https://api.nuget.org/v3/index.json" \
                --api-key ${{ secrets.NUGET_API_KEY }} \
                --skip-duplicate \
                --timeout 300; then
                echo "✅ Successfully published to NuGet.org: $package"
                break
              else
                echo "❌ Failed to publish $package to NuGet.org (attempt $attempt)"
                if [ $attempt -lt $retry_count ]; then
                  echo "Retrying in $retry_delay seconds..."
                  sleep $retry_delay
                  retry_delay=$((retry_delay * 2))  # Exponential backoff
                else
                  echo "❌ All retry attempts failed for: $package"
                  publish_failed=true
                fi
              fi
            done
          fi
        done
        
        if [ "$publish_failed" = true ]; then
          echo "❌ One or more packages failed to publish to NuGet.org"
          exit 1
        fi
        
        echo "✅ All packages successfully published to NuGet.org"
        
    - name: Publish symbol packages to NuGet.org
      run: |
        symbol_publish_failed=false
        retry_count=3
        retry_delay=30
        
        for package in ./artifacts/packages/*.snupkg; do
          echo "Publishing symbol package to NuGet.org: $package"
          
          for attempt in $(seq 1 $retry_count); do
            echo "Attempt $attempt of $retry_count for $package"
            
            if dotnet nuget push "$package" \
              --source "https://api.nuget.org/v3/index.json" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --skip-duplicate \
              --timeout 300; then
              echo "✅ Successfully published symbol package to NuGet.org: $package"
              break
            else
              echo "❌ Failed to publish symbol package $package to NuGet.org (attempt $attempt)"
              if [ $attempt -lt $retry_count ]; then
                echo "Retrying in $retry_delay seconds..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))  # Exponential backoff
              else
                echo "❌ All retry attempts failed for symbol package: $package"
                symbol_publish_failed=true
              fi
            fi
          done
        done
        
        if [ "$symbol_publish_failed" = true ]; then
          echo "❌ One or more symbol packages failed to publish to NuGet.org"
          exit 1
        fi
        
        echo "✅ All symbol packages successfully published to NuGet.org"